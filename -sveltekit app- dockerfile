# Stage 1: Build
FROM node:lts AS builder

# A small line inside the image to show who made it
LABEL Developers="Bora ERESICI"

WORKDIR /app2

COPY package*.json .
#COPY pnpm-lock.yaml .

# Clean install all node modules
RUN npm ci

RUN npm i -g pnpm
RUN npm install

# Copy all local files into the image
COPY . .

RUN npm run build
RUN npm prune --prod

# Delete source code files that were used to build the app that are no longer needed
RUN rm -rf src/ static/ emailTemplates/ docker-compose.yml

# The USER instruction sets the user name to use as the default user for the remainder of the current stage
USER node:node

# Stage 2: Deploy
FROM node:lts AS deployer

WORKDIR /app2

#COPY --from=builder /app2/build ./build
COPY --from=builder /app2/package.json .

EXPOSE 3000

ENV NODE_ENV=production
ENV HOST=0.0.0.0

CMD ["node", "build/index.js"]
